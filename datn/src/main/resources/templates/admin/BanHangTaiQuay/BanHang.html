<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title>Dashboard - Voler Admin Dashboard</title>
    <!-- Link các thư viện CSS và JavaScript cho Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.2/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.2/dist/sweetalert2.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://kit.fontawesome.com/b0d3163487.js" crossorigin="anonymous"></script>
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css"
          rel="stylesheet">

    <!-- Các file CSS của dự án -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.css}">
    <link rel="stylesheet" th:href="@{/css/Chart.min.css}">
    <link rel="stylesheet" th:href="@{/css/perfect-scrollbar.css}">
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <link rel="stylesheet" th:href="@{/css/bhThanhToan.css}">
    <link rel="stylesheet" th:href="@{/css/banhang.css}">


    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        tableDSSP {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        thead {
            background-color: #007bff;
            color: white;
        }

        tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }


    </style>

</head>

<body>

<div id="app">
    <span th:replace="~{fragments/sidebar :: sidebar}"></span>
    <div id="main">
        <span th:replace="~{fragments/header :: header}"></span>
        <div class="main-content container-fluid" layout:fragment="content">
            <!--                Tạo khung Bán hàng -->
            <div class="container-custom ">
                <div class="row">
                    <!-- Phần tiêu đề -->
                    <div class="col-md-12 mb-4">
                        <h1 class="text-lg-center">Bán Hàng Tại Quầy</h1>
                    </div>
                    <!-- Nội dung -->
                    <!--tạo hóa đơn chờ                    -->
                    <div class="d-flex justify-content-end mb-4">
                        <input type="text" id="maHD" hidden readonly/>
                        <button id="tao-hd-cho"
                                class="taohdchobuuton btn btn-primary font-weight-bold px-4 py-2 rounded shadow"
                                style="background: #1e90ff ">

                            Tạo hóa đơn
                        </button>
                    </div>

                    <!--hiển thị hóa đơn chờ-->
                    <div class="border-b">
                        <div id="tabs-container" class="flex space-x-2 ml-3">
                        </div>
                    </div>
                    <!--  hiển thị sản phẩm chọn hóa đơn  -->
                    <hr>
                    <br>
                    <div class=" p-4">
                        <!-- Nút kích hoạt modal -->
                        <div class="d-flex justify-content-end">
                            <button id="hienThiDanhSachSanPham"
                                    style="background-color: #1e90ff; color: white; padding: 10px 20px; font-size: 16px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;"
                                    onmouseover="this.style.backgroundColor='#1e90ff'; this.style.transform='scale(1.05)';"
                                    onmouseout="this.style.backgroundColor='#1e90ff'; this.style.transform='scale(1)';"
                                    onfocus="this.style.boxShadow='0 0 5px rgba(72, 212, 67, 0.8)';"
                                    onblur="this.style.boxShadow='none';">
                                Thêm sản phẩm
                            </button>
                        </div>

                        <!-- Modal (cửa sổ hiện ra) dành riêng cho danh sách sản phẩm -->
                        <div id="modalDachSachSanPham" class="modal-overlay-danh-sach-san-pham-unique"
                             style="display: none;">
                            <div class="modal-content-danh-sach-san-pham-unique">
                                <h1>Danh sách sản phẩm</h1>

                                <!-- Load danh sách sản phẩm -->
                                <table id="tableDanhSachSanPham" class="table table-striped mt-3">
                                    <thead class="table-primary">
                                    <tr>
                                        <th scope="col" class="text-center">STT</th>
                                        <th scope="col" class="text-center">Ảnh</th>
                                        <th scope="col" class="text-center">Tên Sản Phẩm</th>
                                        <th scope="col" class="text-center">Giá Bán</th>
                                        <th scope="col" class="text-center">Số Lượng</th>
                                        <th scope="col" class="text-center">Kích Thước</th>
                                        <th scope="col" class="text-center">Màu Sắc</th>
                                        <th scope="col" class="text-center">Trạng Thái</th>
                                        <th scope="col" class="text-center">Hành Động</th>
                                    </tr>
                                    </thead>
                                    <tbody id="danhSachSanPham">
                                    <!-- Dữ liệu sẽ được thêm vào đây -->
                                    </tbody>
                                </table>

                                <button onclick="hideModalDanhSachSanPham()">Đóng</button>
                            </div>
                        </div>

                        <div class="border-top mt-1 mb-3"></div>

                        <!-- Container hiển thị nội dung của hóa đơn khi chọn sản phẩm -->
                        <div id="content-container"></div>
                    </div>
                    <!--Tiếp-->
                    <!--                  div  Tài Khoản  -->
                    <div class="container-account mt-4">
                        <hr>
                        <div class="row">
                            <!-- Phần tiêu đề -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <h2 class="font-bold">Tài Khoản :</h2>
                                </div>
                                <div class="col-md-4">
                                    <button id="chon-khach-hang" class="btn-select-customer"
                                            style="background: #1e90ff ">
                                        Chọn khách hàng
                                    </button>
                                </div>
                            </div>

                            <div class="row">
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <h4>Tên khách hàng: <span id="tenKhachHang">Đang tải...</span></h4>
                                    </div>
                                    <div class="col-md-4">
                                        <h4>Gmail: <span id="gmail">Đang tải...</span></h4>
                                    </div>
                                    <div class="col-md-4">
                                        <h4>Số điện thoại: <span id="soDienThoai">Đang tải...</span></h4>
                                    </div>
                                </div>

                                <!-- Modal cho chọn khách hàng -->
                                <div id="modalChonKhachHang" class="modal-overlay-customer">
                                    <div class="modal-content-customer">
                                        <h1>Danh sách khách hàng</h1>

                                        <table id="tableKhachHang" class="table table-striped mt-3">
                                            <thead class="table-primary">
                                            <tr>
                                                <th class="text-center">STT</th>
                                                <th class="text-left">Tên khách hàng</th>
                                                <th class="text-left">Email</th>
                                                <th class="text-left">Số điện thoại</th>
                                                <th class="text-center">Trạng thái</th>
                                                <th class="text-center">Hành động</th>
                                            </tr>
                                            </thead>
                                            <tbody id="listKhachHang">
                                            <!-- Dữ liệu sẽ được điền vào đây từ JS -->
                                            </tbody>
                                        </table>
                                        <button onclick="hideModalKhachHang()">Đóng</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br>
                        <!--                    Thanh toán              -->
                        <div>
                            <h1 class="font-weight-bold text-xl">Thanh toán</h1>
                            <div class="w-100 border-top border-secondary my-3"></div>

                            <div>


                                <!-- Thông tin thanh toán -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <!-- Giao hàng -->
                                        <div class="d-flex align-items-center justify-content-between mb-3">
                                            <span class="font-weight-bold">Giao hàng:</span>
                                            <button id="toggle-button" class="btn btn-secondary">
                                                <span class="toggle-dot"></span>
                                            </button>
                                        </div>

                                        <!--                                        thông tin giao hàng-->
                                        <div class="m-3">
                                            <!-- Khách thanh toán -->

                                            <div class="row">
                                                <div class="col-4"><span
                                                        class="font-weight-bold">Khách thanh toán:</span></div>
                                                <div class="col-2">
                                                    <button id="thanhToan"
                                                            class="btn btn-info d-flex align-items-center">
                                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                                                             viewBox="0 0 24 24"
                                                             stroke-width="1.5" stroke="currentColor"
                                                             class="bi bi-credit-card"
                                                             style="width: 20px; height: 20px;">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                  d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="col-6"> <!-- Tiền Khách Đưa -->
                                                    <div class="mb-3" style="font-weight: bold; color: black;">
                                                        <p class="mb-1 font-weight-bold">Tiền Khách Đưa:</p>
                                                        <span id="tienKhachDuaAll"
                                                              style="font-weight: bold; color: black;"></span>
                                                    </div>
                                                </div>
                                            </div>


                                            <div class="row mb-3">
                                                <div class="col-3">
                                                    <label for="tenPGGGen" class="font-weight-bold">Mã giảm giá:</label>
                                                </div>
                                                <div class="col-9 d-flex">
                                                    <div class="d-flex align-items-center" style="gap: 10px;">
                                                        <input type="text" id="tenPGGGen" class="form-control"
                                                               placeholder=""
                                                               style="width: 80%; padding: 10px; font-size: 14px; border-radius: 8px; border: 1px solid #ddd; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); height: auto;">
                                                        <button hidden id="loadPGG" class="btn btn-primary"
                                                                style="width: auto; padding: 10px 20px; font-size: 14px; border-radius: 8px; background-color: #1e90ff; border: 2px solid #1e90ff; color: #ffffff; transition: background-color 0.3s, transform 0.3s;">
                                                            Áp dụng
                                                        </button>
                                                    </div>

                                                </div>
                                            </div>

                                            <style>
                                                #loadPGG:hover {
                                                    background-color: #007bff; /* Màu xanh khi hover */
                                                    transform: scale(1.05); /* Tăng kích thước nút khi hover */
                                                }
                                            </style>

                                            <!-- Tiền hàng -->
                                            <div class="row mb-3">
                                                <div class="col-5">
                                                    <p class="mb-1 font-weight-bold">Tiền hàng:</p>
                                                </div>
                                                <div class="col-7">
                                                    <span id="tienHang" style="font-weight: bold; color: black;"></span>
                                                </div>
                                            </div>

                                            <!-- Giảm giá -->
                                            <div class="row mb-3">
                                                <div class="col-5">
                                                    <p class="mb-1 font-weight-bold">Giảm giá:</p>
                                                </div>
                                                <div class="col-7">
                                                    <span id="giamGia" style="font-weight: bold; color: black;"></span>
                                                </div>
                                            </div>

                                            <!-- Tổng tiền -->
                                            <div class="row mb-3">
                                                <div class="col-5">
                                                    <p class="mb-1 font-weight-bold">Tổng tiền:</p>
                                                </div>
                                                <div class="col-7">
                                                    <span id="tongTien"
                                                          style="font-weight: bold; color: #f60101; font-size: 20px;"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <button id="thanhToanTong" class="btn btn-primary">
                                            Thanh Toán
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <!-- Thông tin giao hàng 2 -->
                                        <div id="thongTinShip2" class="col-12 col-md-6"></div>

                                        <!-- Thông tin giao hàng 1 -->
                                        <div id="thongTinShip" class="col-12 col-md-12 hidden">
                                            <form id="chinh-sua-form">
                                                <!-- Tên khách hàng -->
                                                <div class="form-group">
                                                    <label for="edit-ten" class="form-label">Tên Khách Hàng</label>
                                                    <input type="text" id="edit-ten" class="form-control"
                                                           placeholder="Nhập tên khách hàng">
                                                </div>

                                                <!-- Số điện thoại -->
                                                <div class="form-group">
                                                    <label for="edit-sdtNguoiNhan" class="form-label">Số điện
                                                        thoại</label>
                                                    <input type="text" id="edit-sdtNguoiNhan" class="form-control"
                                                           value="">
                                                </div>

                                                <!-- Địa chỉ -->
                                                <div class="row">
                                                    <div class="col-12 col-md-4">
                                                        <div class="form-group">
                                                            <label for="edit-tinhthanh" class="form-label">Tỉnh/Thành
                                                                phố</label>
                                                            <select id="edit-tinhthanh" class="form-control">
                                                                <option value="" selected>Chọn tỉnh thành</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-12 col-md-4">
                                                        <div class="form-group">
                                                            <label for="edit-quanhuyen"
                                                                   class="form-label">Quận/Huyện</label>
                                                            <select id="edit-quanhuyen" class="form-control">
                                                                <option value="" selected>Chọn quận huyện</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-12 col-md-4">
                                                        <div class="form-group">
                                                            <label for="edit-phuongxa"
                                                                   class="form-label">Phường/Xã</label>
                                                            <select id="edit-phuongxa" class="form-control">
                                                                <option value="" selected>Chọn phường xã</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Địa chỉ cụ thể -->
                                                <div class="form-group">
                                                    <label for="edit-diachi" class="form-label">Địa chỉ cụ thể</label>
                                                    <input type="text" id="edit-diachi" class="form-control">
                                                </div>

                                                <!-- Phí vận chuyển -->
                                                <div class="form-group">
                                                    <label for="phiVanChuyen" class="form-label">Phí vận chuyển</label>
                                                    <input type="number" id="phiVanChuyen" min="0" class="form-control"
                                                           placeholder="0 VNĐ">
                                                </div>

                                                <!-- Ghi chú -->
                                                <div class="form-group">
                                                    <label for="noteThongTin" class="form-label">Ghi chú</label>
                                                    <textarea id="noteThongTin" class="form-control"
                                                              rows="4"></textarea>
                                                </div>
                                            </form>

                                            <div class="d-flex align-items-center mt-4">
                                                <img src="https://cdn.haitrieu.com/wp-content/uploads/2022/05/Logo-GHN-Slogan-En.png"
                                                     class="w-25 h-25">
                                                <p class="ml-4">Thời gian dự kiến: <span id="thoiGianDuKien"></span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>
                        </div>


                    </div>

                    <!--                    Modal-->
                    <div id="modalThanhToan" class="modal fade" tabindex="-1" aria-labelledby="modalThanhToanLabel"
                         aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalThanhToanLabel">Thanh toán</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="inputSoTien" class="form-label">Tiền khách đưa</label>
                                        <input id="inputSoTien" type="text" class="form-control"
                                               placeholder="Nhập số tiền" value="">
                                    </div>
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                        <button id="btnTienMat" type="button" class="btn btn-success w-100 w-md-auto">
                                            Tiền mặt
                                        </button>
                                        <button id="btnChuyenKhoan" type="button"
                                                class="btn btn-success w-100 w-md-auto">
                                            Chuyển khoản
                                        </button>
                                    </div>
                                    <div id="tienThieu" class="mt-3"></div>

                                    <table id="tablePhuongThucThanhToan" class="table table-striped mt-3">
                                        <thead class="table-primary">
                                        <tr>
                                            <th class="text-left">STT</th>
                                            <th class="text-left">Số tiền</th>
                                            <th class="text-left">Phương thức</th>
                                            <th class="text-left">Hành động</th>
                                        </tr>
                                        </thead>
                                        <tbody id="listPhuongThucThanhToan">
                                        </tbody>
                                    </table>
                                </div>
                                <div class="modal-footer">
                                    <div class="d-flex justify-content-between w-100">
                                        <div>
                                            <p><strong>Tiền khách đưa: </strong><span id="tienKhachDuoc">0</span></p>
                                            <p><strong>Tổng tiền: </strong><span id="tienThieu2">0</span></p>
                                            <p><strong>Tiền còn thiếu: </strong><span id="tienConThieu">0</span></p>
                                        </div>
                                        <button id="xacNhanThanhToan" class="btn btn-primary">Xác nhận</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--                Thong báo   -->
                    <div id="notification" class="notification">
                        <span id="notification-message"></span>
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                    <!--            modal so luong    -->
                    <div id="modalSoLuong" class="modal fade" tabindex="-1" role="dialog"
                         aria-labelledby="modalLabelSoLuong" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalLabelSoLuong">Số lượng</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <input type="number" id="soLuongInput" value="1" min="1"
                                           class="form-control"/>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close
                                    </button>
                                    <button id="soLuongThayDoi" type="button" class="btn btn-primary">Confirm</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--cuoi trong khung-->
                </div>
            </div>
            <span th:replace="~{fragments/footer :: footer}"></span>
        </div>
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<script th:src="@{/js/feather.min.js}"></script>
<script th:src="@{/js/perfect-scrollbar.min.js}"></script>
<script th:src="@{/js/app.js}"></script>
<script th:src="@{/js/Chart.min.js}"></script>
<script th:src="@{/js/apexcharts.min.js}"></script>
<script th:src="@{/js/dashboard.js}"></script>
<script th:src="@{/js/main.js}"></script>
<!-- Liên kết jQuery -->

</body>
<script>

    var idPGG = null;
    var maPGG = '';
    var GiamToiDa = 0;
    var countHD = 0;
    var tongTienTrongHD = 0;
    let tabsData = [];
    var idTabHD = null;
    var maHD = null

    //hai
    function renderTabs() {
        const tabsContainer = document.getElementById('tabs-container');
        const contentContainer = document.getElementById('content-container');

        // Clear old content
        tabsContainer.innerHTML = '';
        contentContainer.innerHTML = '';

        tabsData.forEach((tab, index) => {
            const tabButton = document.createElement('button');
            tabButton.classList.add('tab', 'h-d-c', 'px-4', 'py-2', 'bg-gray-200', 'hover:bg-gray-300');

            if (index === 0) tabButton.classList.add('tab-active');

            tabButton.textContent = tab.title;

            tabButton.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

                tabButton.classList.add('tab-active');
                const tabContent = document.getElementById(`tab-content-${tab.id}`);
                tabContent.classList.remove('hidden');

                idTabHD = tab.id;
                PhieuGiamGiaPhuHop(tongTienTrongHD);
                getDuLieu(idTabHD);
                getPhuongThucThanhToan(idTabHD);

                if (!tabsData[index].contentLoaded) {
                    // getDuLieu(idTabHD);
                }
            });

            // Thêm tabButton vào container chứa các tab
            tabsContainer.appendChild(tabButton);

            // Tạo nội dung cho tab với nội dung hóa đơn
            const tabContent = document.createElement('div');
            tabContent.id = `tab-content-${tab.id}`;
            tabContent.classList.add('tab-content', 'p-4');

            // Nếu hóa đơn có nội dung, gán vào tabContent
            tabContent.innerHTML = tab.content || 'Không có nội dung';

            // Nếu không phải tab đầu tiên, ẩn nội dung
            if (index !== 0) tabContent.classList.add('hidden');

            // Thêm nội dung của tab vào container nội dung
            contentContainer.appendChild(tabContent);
        });
        if (tabsData.length > 0) {
            document.querySelector('.tab').click();
        }

    }

    //Tạo Hóa Đơn hai
    document.getElementById('tao-hd-cho').addEventListener('click', () => {
        taoHoaDon();
    });

    //hai
    function taoHoaDon() {
        $.ajax({
            url: '/api/ban-hang',
            method: 'GET',
            success: function (response) {
                const countHD = response.length;
                if (countHD >= 6) {
                    showNotification("Đã đủ 6 hóa đơn chờ, không thể tạo thêm", 'thatBai');
                    return;
                }
                $.ajax({
                    url: `/api/ban-hang/tao-hoa-don`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({}),
                    success: function (response) {
                        idHoaDon(() => {
                            const lastTabIndex = tabsData.length - 1;
                            document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
                            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

                            document.querySelectorAll('.tab')[lastTabIndex].classList.add('tab-active');
                            document.querySelectorAll('.tab-content')[lastTabIndex].classList.remove('hidden');
                            // PhieuGiamGiaPhuHop(tongTienTrongHD);
                            getDuLieu(tabsData[lastTabIndex].id);
                            loadTenKhachHang(1);

                        });
                        showNotification("Tạo hóa đơn thành công", "thanhCong");
                    },
                });
            },
            error: function (xhr, status, error) {
                console.error('Lỗi khi lấy dữ liệu hóa đơn:', error);
            }
        });
    }

    //load hd chờ hải
    function idHoaDon(callback) {
        $.ajax({
            url: `/api/ban-hang`,
            method: 'GET',
            success: function (response) {
                countHD = response.length;
                tabsData = response.map((hd, index) => ({
                    id: hd.id,
                    title: `Hóa đơn ${hd.id}`,
                    content: '',
                    contentLoaded: false
                }));

                renderTabs(function () {
                    PhieuGiamGiaPhuHop(tongTienTrongHD);
                    if (callback) callback();
                });
            },
            error: function (xhr, status, error) {
                console.error('Lỗi:', error);
            }
        });
    }

    window.onload = function () {
        idHoaDon();
    };

    const formatVND = (tongtien) => {
        if (tongtien < 0) {
            tongtien = 0;
        }
        return tongtien.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ' VNĐ';
    }

    //hai
    let idSP = [];  // Khởi tạo mảng idSP ngoài hàm để nó không bị reset mỗi lần chuyển tab

    function getDuLieu(idHoaDon) {
        const allTabContents = document.querySelectorAll('.tab-content');
        allTabContents.forEach(tab => {
            tab.style.display = 'none';
        });

        tongTienTrongHD = 0;
        tongTienSauKhiCoVoucher = 0;
        tienKhachDaTra = 0;
        tienGiams = 0;
        tongTienUpdate = 0;
        $('#tienThieu2').text(`${formatVND(0)}`);
        $('#tienConThieu').text(`${formatVND(0)}`);

        $.ajax({
            url: `/api/hoa-don/${idHoaDon}`,
            method: 'GET',
            success: function (response) {
                const hdctList = response || [];
                const tabContent = document.getElementById(`tab-content-${idHoaDon}`);
                tabContent.style.display = 'block';

                if (hdctList.length === 0) {
                    console.log('Không có sản phẩm trong hóa đơn này.');
                    tabContent.innerHTML = `
                <div class="content bg-white flex flex-col items-center justify-center py-12">
                    <div class="text-center">
                        <img src="https://www.fotofabrikas.lt/data/upload/images/page/empty_cart.png" alt="Empty Cart" class="w-1/2 mx-auto mb-6">
                        <p class="text-gray-500 text-2xl mb-4">Không có sản phẩm trong hóa đơn này</p>
                    </div>
                </div>`;
                } else {
                    // Kiểm tra nếu mảng idSP đã có dữ liệu, tránh thêm sản phẩm trùng lặp
                    idSP = [];  // Reset idSP mỗi lần lấy dữ liệu mới, nếu cần

                    // Tính tổng tiền và push sản phẩm vào mảng idSP
                    hdctList.forEach(item => {
                        const donGia = item.donGia != null ? item.donGia : 0;
                        const soLuong = item.soLuong || 0;
                        tongTienTrongHD += donGia * soLuong; // Cộng dồn tổng tiền
                        // Push sản phẩm vào mảng idSP
                        idSP.push({
                            maHD: item.maHD,
                            id: item.idSPCT,  //  id chi tiết sản phẩm
                            tenSanPham: item.tenSanPham,
                            donGia: donGia,
                            soLuong: soLuong,
                            tongTien: donGia * soLuong
                        });
                    });


                    const maHDs = hdctList.length > 0 ? hdctList[0].maHD : '';
                    $('#maHD').val(maHDs);
                    $('#tienKhachDuaAll').text(formatVND(tienDaThanhToan));
                    $('#tenPGGGen').val(maPGG);
                    $('#tienHang').text(formatVND(tongTienTrongHD));
                    $('#giamGia').text(formatVND(GiamToiDa));
                    $('#tongTien').text(formatVND(tongTienTrongHD - GiamToiDa));
                    getPhuongThucThanhToan(idHoaDon);

                    tongTienSauKhiCoVoucher = tongTienTrongHD - GiamToiDa;
                    tienGiams = GiamToiDa;
                    $('#tienThieu2').text(`${formatVND(tongTienSauKhiCoVoucher)}`);
                    $('#tienConThieu').text(`${formatVND(tongTienSauKhiCoVoucher - tienDaThanhToan)}`);
                    PhieuGiamGiaPhuHop(tongTienTrongHD);
                    updateTongTien(idHoaDon);
                    tienThua = tienDaThanhToan - tongTienTrongHD - GiamToiDa;

                    console.log("idSP chứa các sản phẩm trong hóa đơn:", idSP);

                    tabContent.innerHTML = `
                <table id="tableHoaDonChiTiet" class="table table-striped mt-3" >
                    <thead class="table-primary">
                        <tr>
                            <th class="px-6 py-3 text-left">STT</th>
                            <th class="px-6 py-3 text-left">Sản phẩm</th>
                            <th class="px-6 py-3 text-left">Số lượng</th>
                            <th class="px-6 py-3 text-left">Tổng tiền</th>
                            <th class="px-6 py-3 text-left">Hành Động</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${hdctList.map((hdct, index) => {
                        const tenSanPham = hdct.tenSanPham || 'Không rõ tên';
                        const mauSac = hdct.mauSac || 'Không rõ màu';
                        const donGia = hdct.donGia || 0;
                        const soLuong = hdct.soLuong || 0;
                        const tongTien = donGia * soLuong;

                        return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <h4>${tenSanPham} - ${mauSac}</h4>
                            <h7  style="color: red">Giá:${formatVND(donGia)}</h7>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${soLuong}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatVND(tongTien)}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><a href=""><i class="fa-solid fa-delete-left"></i></a></td>
                    </tr>
                `;
                    }).join('')}
                    </tbody>
                </table>
            `;
                }
            },
            error: function (xhr, status, error) {
                console.error('Lỗi khi lấy dữ liệu hóa đơn:', xhr.responseText || error);
                const tabContent = document.getElementById(`tab-content-${idHoaDon}`);
                tabContent.innerHTML = `<p class="text-red-500">Không thể tải dữ liệu. Vui lòng thử lại sau.</p>`;
            }
        });
    }


    //add pgg vào hóa đơn //hai
    function addPhieuGiamGia(idHD, idPGG) {
        $.ajax({
            url: `/api/hoa-don/update-phieu-giam-gia/${idHD}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                "phieuGiamGia": {
                    id: idPGG
                }
            }),
            success: function (response) {
            },
            error: function (error) {
                console.error("Error updating PhieuGiamGia", error);
            }
        });
    }

    // Chọn PGG Phù Hợp với giá trị lớn nhất //hai
    function PhieuGiamGiaPhuHop(max) {

        $.ajax({
            url: `/api/hoa-don/phieu-giam-gia-phu-hop/${max}`,
            method: 'GET',
            contentType: 'application/json',
            success: function (response) {
                if (response && response.length <= 0) {
                    idPGG = null;
                    maPGG = '';
                    GiamToiDa = 0;
                } else if (max < response[0].donToiThieu) {
                    idPGG = null;
                    maPGG = '';
                    GiamToiDa = 0;
                } else {
                    maPGG = response[0].ma;
                    idPGG = response[0].id;
                    // if (response[0].loaiVoucher === true) {
                    //     let phanTram = max / response[0].giaTriGiam;
                    //     if (response[0].giaTriMax < phanTram) {
                    //         GiamToiDa = response[0]?.giaTriMax || 0;
                    //     } else {
                    //         GiamToiDa = phanTram;
                    //     }
                    // } else {
                    //     GiamToiDa = response[0]?.giaTriMax || 0;
                    // }


                    GiamToiDa = response[0]?.giaTriMax || 0;
                }
                if (idPGG) {
                    addPhieuGiamGia(idTabHD, idPGG);
                } else {
                }
            },
        });
    }

    let danhSachSanPham = [];

    function loadDanhSachSanPham() {
        $("#danhSachSanPham").html('<tr><td colspan="9" class="text-center">Đang tải...</td></tr>'); // Hiển thị thông báo đang tải
        $.ajax({
            url: '/api/ban-hang/danh-sach-san-pham-chi-tiet',  // Gọi API
            method: 'GET',
            success: function (result) {
                // Lưu danh sách sản phẩm vào biến toàn cục
                danhSachSanPham = result;

                let list = "";
                result.forEach((sp, index) => {
                    let hinhAnhSrc = sp.hinhAnh ? `/desktop-images/${sp.hinhAnh}` : '/desktop-images/xs10109.jpg';

                    list += `
                <tr class="hover:bg-gray-100">
                    <td class="text-center">${index + 1}</td>
                    <td>
                        <div style="border: 1px solid #ccc; text-align: center; padding: 2px;">
                            <img src="${hinhAnhSrc}" alt="Hình ảnh"
                                style="width: 50px; height: 40px; object-fit: cover; display: block; margin: 0 auto;" />
                        </div>
                    </td>
                    <td class="font-bold">
                        <h4>${sp.tenSanPham}</h4>
                        <h7 style="color: #3dd5f3">${sp.thuongHieu}</h7>
                        <h7 style="color: #3dd5f3">${sp.chatLieu}</h7>
                    </td>
                    <td>${sp.giaBan}</td>
                    <td class="text-center">${sp.soLuong}</td>
                    <td class="text-center">${sp.kichCo || 'N/A'}</td>
                    <td class="text-center">${sp.mauSac || 'N/A'}</td>
                    <td class="text-center">${sp.trangThai === 1 ? 'Còn hàng' : 'Hết hàng'}</td>
                    <td class="text-center">
                        <button class="themSanPham bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" data-id="${sp.id}" data-gia-ban="${sp.giaBan}">
                            Thêm
                        </button>
                    </td>
                </tr>`;
                });
                $("#danhSachSanPham").html(list);

                // Hủy khởi tạo DataTable cũ (nếu có) trước khi khởi tạo lại
                if ($.fn.dataTable.isDataTable('#tableDanhSachSanPham')) {
                    $('#tableDanhSachSanPham').DataTable().destroy();
                }

                // Khởi tạo lại DataTable sau khi tải dữ liệu
                $('#tableDanhSachSanPham').DataTable({
                    "paging": true,
                    "searching": false,
                    "ordering": true,
                    "info": true,
                    "language": {
                        "paginate": {
                            "previous": "Trước",
                            "next": "Sau"
                        },
                        "lengthMenu": "Hiển thị _MENU_ bản ghi mỗi trang",
                        "zeroRecords": "Không tìm thấy kết quả phù hợp",
                        "info": "Hiển thị trang _PAGE_ trong tổng số _PAGES_",
                        "infoEmpty": "Không có dữ liệu",
                        "infoFiltered": "(lọc từ tổng số _MAX_ bản ghi)"
                    },
                    "dom": 'lrtip'
                });
            },
            error: function () {
                $("#danhSachSanPham").html('<tr><td colspan="9" class="text-center text-red-500">Không thể tải dữ liệu!</td></tr>');  // Thông báo lỗi khi không thể tải dữ liệu
            }
        });
    }

    function laySoLuongSanPham(id) {
        const sanPham = danhSachSanPham.find(sp => sp.id === id);
        return sanPham ? sanPham.soLuong : 0;
    }


    //hai
    $("#danhSachSanPham").on('click', '.themSanPham', function () {
        $("#soLuongInput").val(1);
        showModalSoLuong(); // Hiển thị modal
        itemId = $(this).data('id');
        //đã lấy ra id sp
        giaBan = $(this).data('gia-ban');
        console.log(itemId + " idspct")

    });
    //hai addsp
    $('#soLuongThayDoi').click(function () {
        const soLuongMoi = parseInt($("#soLuongInput").val(), 10);
        if (isNaN(soLuongMoi) || soLuongMoi <= 0) {
            alert("Số lượng phải là số nguyên dương lớn hơn 0!");
            return;
        }

        const sanPhamTrung = idSP.find(sp => sp.id === itemId);
        const checkTrung = !!sanPhamTrung;
        const soLuongHienTai = sanPhamTrung ? sanPhamTrung.soLuong : 0;
        const soLuongCuoiCung = checkTrung ? soLuongHienTai + soLuongMoi : soLuongMoi;

        const soLuongTon = laySoLuongSanPham(itemId);
        if (soLuongMoi > soLuongTon) {
            alert(`Số lượng không đủ! Chỉ còn ${soLuongTon} sản phẩm trong kho.`);
            return;
        }
        $.ajax({
            url: `/api/san-pham-chi-tiet/cap-nhat-so-luong?id=${itemId}&soLuongGiam=${soLuongMoi}`,
            method: 'PUT',
            success: function () {
                console.log("Cập nhật số lượng tồn kho thành công!");

                // Tiếp tục thêm sản phẩm vào hóa đơn sau khi cập nhật thành công
                const data = {
                    donGia: giaBan,
                    soLuong: soLuongCuoiCung,
                    trangThai: 1,
                    hoaDon: {id: idTabHD},
                    sanPhamChiTiet: {id: itemId, giaBan: giaBan}
                };

                const url = checkTrung
                    ? `/api/hoa-don-chi-tiet/update-so-luong-sp`
                    : `/api/hoa-don-chi-tiet/danh-sach-san-pham/add`;
                const method = checkTrung ? 'PUT' : 'POST';
                const successMessage = checkTrung ? "Cập nhật số lượng thành công" : "Thêm sản phẩm thành công";

                goiApiAddUP(url, method, data, successMessage);

                soLuongTonFE = soLuongTon - soLuongMoi;

                const row = $(`button[data-id='${itemId}']`).closest('tr');
                row.find('td:eq(4)').text(soLuongTonFE);
                console.log(soLuongTonFE);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.error('Lỗi khi cập nhật số lượng tồn kho:', textStatus, errorThrown);
                alert(`Không thể cập nhật số lượng tồn kho: ${jqXHR.responseText || "Unknown error"}`);
            }
        });
    });

    // Hàm goiApiAddUP
    function goiApiAddUP(url, method, data, successMessage) {
        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function () {
                showNotification(successMessage, "thanhCong");
                hideModalSoLuong();
                hideModalDanhSachSanPham();
                getDuLieu(idTabHD);
                PhieuGiamGiaPhuHop(tongTienTrongHD);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.error('Lỗi khi gọi API:', textStatus, errorThrown);
                alert(`Lỗi khi gửi yêu cầu: ${jqXHR.responseText || "Unknown error"}`);
                hideModalSoLuong();  // Ẩn modal nếu có lỗi
            }
        });
    }


    //hai
    function updateTongTien(idHoaDon) {
        if (typeof tongTienSauKhiCoVoucher !== 'number' || typeof tienGiams !== 'number') {
            return;
        }
        $.ajax({
            url: `/api/hoa-don/update-tong-tien/${idHoaDon}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                tongTien: tongTienSauKhiCoVoucher,
                tienGiam: tienGiams
            }),
            success: function (response) {
            },
            error: function (xhr, status, error) {
                // Nếu có lỗi, log lỗi và hiển thị thông báo
                showNotification("Cập nhật tổng tiền thất bại", "thatBai");
            }
        });
    }

    // Hiển thị modal hai
    function showModalSoLuong() {
        var modal = new bootstrap.Modal(document.getElementById('modalSoLuong'));
        modal.show();
    }

    function showModalThanhToan() {
        var modal = new bootstrap.Modal(document.getElementById('modalThanhToan'));
        modal.show();
    }

    //Hàm đóng modal
    function hideModalSoLuong() {
        var modalElement = document.getElementById('modalSoLuong');
        var modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        } else {
        }
    }

    // load Khach hang
    function loadDanhSachKhachHang() {
        $("#listKhachHang").html('<tr><td colspan="6" class="text-center">Đang tải...</td></tr>'); // Hiển thị thông báo đang tải
        $.ajax({
            url: '/api/ban-hang/danh-sach-khach-hang', // Gọi API lấy danh sách khách hàng
            method: 'GET',
            success: function (result) {
                let list = "";
                // Duyệt qua kết quả trả về từ API và xây dựng bảng dữ liệu
                result.forEach((kh, index) => {
                    list += `
                <tr class="hover:bg-gray-100">
                    <td class="text-center">${index + 1}</td>
                    <td>${kh.ten || 'N/A'}</td>
                    <td>${kh.email || 'N/A'}</td>
                    <td class="text-center">${kh.sdt || 'N/A'}</td>
                    <td class="text-center">${kh.trangThai === 1 ? 'Hoạt động' : 'Không hoạt động'}</td>
                    <td class="text-center">
                        <button class="chon-khach-hang bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" data-id="${kh.id}" data-ten-nguoi-nhan="${kh.tenNguoiNhan}" data-sdt="${kh.sdt}">
                            Chọn
                        </button>
                    </td>
                </tr>`;
                });
                $("#listKhachHang").html(list);

                // Hủy khởi tạo DataTable cũ (nếu có) trước khi khởi tạo lại
                if ($.fn.dataTable.isDataTable('#tableKhachHang')) {
                    $('#tableKhachHang').DataTable().destroy();
                }

                // Khởi tạo lại DataTable sau khi cập nhật dữ liệu
                $('#tableKhachHang').DataTable({
                    "paging": true,
                    "searching": false,
                    "ordering": true,
                    "info": true,
                    "language": {
                        "paginate": {
                            "previous": "Trước",
                            "next": "Sau"
                        },
                        "lengthMenu": "Hiển thị _MENU_ bản ghi mỗi trang",
                        "zeroRecords": "Không tìm thấy kết quả phù hợp",
                        "info": "Hiển thị trang _PAGE_ trong tổng số _PAGES_",
                        "infoEmpty": "Không có dữ liệu",
                        "infoFiltered": "(lọc từ tổng số _MAX_ bản ghi)"
                    },
                    "dom": 'lrtip'
                });
            },
            error: function () {
                $("#listKhachHang").html('<tr><td colspan="6" class="text-center text-red-500">Không thể tải dữ liệu!</td></tr>');
            }
        });
    }

    //hai
    function loadTenKhachHang(id) {
        $("#tenKhachHang").text("Đang tải...");
        $.ajax({
            url: `/api/ban-hang/khach-hang/${id}`,
            method: 'GET',
            success: function (response) {
                $("#tenKhachHang").text(response.ten);
                $("#soDienThoai").text(response.sdt);
                $("#gmail").text(response.email);
            },
            error: function () {
                $("#tenKhachHang").text("Không thể tải tên khách hàng!");
            }
        });
    }


    //lấy thông tin khách hàng add vào hóa đơn chờ  //hai
    function getDiaChiKhachHang(idKhachHang) {
        if (idKhachHang != 1) {
            $.ajax({
                url: `/api/ban-hang/dia-chi-mac-dinh-khach-hang/${idKhachHang}`,
                method: 'GET',
                success: function (response) {
                    if (response && Object.keys(response).length > 0) {
                        updateThongTinNguoiNhan(null, null, null, 0, null, idTabHD);
                        getDuLieu(idTabHD);
                    } else {
                        console.log('Response trống');
                    }
                },
                error: function (error) {
                    console.error('Lỗi khi gọi API:', error);
                }
            });
        } else {
            console.log('ID Khách Hàng là 1: Thực hiện các thao tác thiết lập giá trị giao diện');
            $('#edit-ten').val("Khách Lẻ");
            $('#edit-sdtNguoiNhan').val("");
            $('#noteThongTin').val("");
            $('#phiVanChuyen').val(0);
            getDuLieu(idTabHD);
            hideModalKhachHang();
        }

    }

    //hai
    $(document).off('click', '.chon-khach-hang').on('click', '.chon-khach-hang', function () {
        const idKhachHang = $(this).data('id');
        getDiaChiKhachHang(idKhachHang);
        console.log("Đã gọi hàm getDiaChiKhachHang với ID: ", idKhachHang);
        loadTenKhachHang(idKhachHang);
        // Gửi yêu cầu AJAX để cập nhật khách hàng
        $.ajax({
            url: `/api/ban-hang/update-khach-hang/${idTabHD}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                khachHang: {
                    id: idKhachHang
                }
            }),
            success: function () {
                hideModalKhachHang();
                console.log("Dữ liệu đã được cập nhật cho tab: ", idTabHD);
            },
            error: function (xhr, status, error) {
                console.log("Lỗi khi gửi yêu cầu AJAX:", error);  // Log lỗi nếu có
            }
        });

    });

    //hai
    function updateThongTinNguoiNhan(nguoiNhan, sdtNguoiNhan, diaChiNguoiNhan, tienShip, ghichu, idhd) {
        $.ajax({
            url: `/api/hoa-don/update-thong-tin-nguoi-nhan/${idhd}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                tenNguoiNhan: nguoiNhan,
                sdt: sdtNguoiNhan,
                diaChiNguoiNhan: diaChiNguoiNhan,
                ghiChu: ghichu,
                phiShip: tienShip
            }),
            success: function (response) {
            },
        });
    }

    //hai
    $(document).ready(function () {
        loadTenKhachHang(1);  // Gọi API với ID mặc định là 1
    });

    // Hàm để hiển thị modal
    function showModalDanhSachSanPham() {
        document.getElementById('modalDachSachSanPham').style.display = 'flex'; // Hiển thị modal
        loadDanhSachSanPham();
    }

    // Hàm để ẩn modal
    function hideModalDanhSachSanPham() {
        document.getElementById('modalDachSachSanPham').style.display = 'none'; // Ẩn modal
    }

    // Sự kiện khi nhấn nút "Thêm sản phẩm"
    document.getElementById('hienThiDanhSachSanPham').addEventListener('click', function () {
        showModalDanhSachSanPham(); // Hiển thị modal
    });

    //Khach hang
    // Hàm hiển thị modal chọn khách hàng
    function showModalKhachHang() {
        document.getElementById('modalChonKhachHang').classList.add('show');
        loadDanhSachKhachHang();
    }

    // Hàm ẩn modal chọn khách hàng
    function hideModalKhachHang() {
        document.getElementById('modalChonKhachHang').classList.remove('show');
    }

    // Sự kiện khi nhấn nút chọn khách hàng
    document.getElementById('chon-khach-hang').addEventListener('click', function () {
        showModalKhachHang(); // Hiển thị modal chọn khách hàng
        getDuLieu(idTabHD);

    });

    //test
    document.getElementById('thanhToan').addEventListener('click', function () {
        showModalThanhToan()
    });

    //Thanh thông báo
    function showNotification(message, status) {
        var notification = document.getElementById('notification');
        var notificationMessage = document.getElementById('notification-message');
        var progressBar = document.getElementById('progress-bar');

        notification.className = 'notification'; // Reset class
        if (status === 'thanhCong') {
            notification.classList.add('thanhCong');
        } else if (status === 'thatBai') {
            notification.classList.add('thatBai');
        }

        if (message) {
            notificationMessage.textContent = message;
            notification.style.display = 'block';
            progressBar.style.width = '100%';

            setTimeout(function () {
                progressBar.style.width = '0';
            }, 10);

            setTimeout(function () {
                notification.style.display = 'none';
                progressBar.style.width = '100%';
            }, 3010);
        }
    }


    document.getElementById('tienHang').addEventListener('input', updateTongTien);
    document.getElementById('giamGia').addEventListener('input', updateTongTien);
    document.getElementById('tongTien').addEventListener('input', updateTongTien);


    // hai làm al
    //add phuong thức thanh toán
    function addPhuongThucThanhToanTienMat(idHoaDon, tienDaThanhToan) {
        $.ajax({
            url: `/api/ban-hang/them-phuong-thuc-thanh-toan/${idHoaDon}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                tienDaThanhToan: tienDaThanhToan,
                tenThanhToan: "Tiền Mặt",
                loaiThanhToan: true,
                trangThai: 1
            }),
            success: function (response) {
                getDuLieu(idTabHD);
            },
            error: function (xhr, status, error) {
                // Log thông tin lỗi
                console.error("Lỗi khi gửi yêu cầu:");
                console.error("Trạng thái:", status);
                console.error("Mô tả lỗi:", error);
                console.error("Phản hồi từ server:", xhr.responseText);
            }
        });
    }


    function addPhuongThucThanhToanChuyenKhoan(idHoaDon, tienDaThanhToan) {
        $.ajax({
            url: `/api/ban-hang/them-phuong-thuc-thanh-toan/${idHoaDon}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                tienDaThanhToan: tienDaThanhToan,
                tenThanhToan: "Chuyển Khoản",
                loaiThanhToan: true,
                trangThai: 1
            }),
            success: function (response) {
                getDuLieu(idTabHD);
            },
        });
    }

    //getdu lieu pptt hai
    function getPhuongThucThanhToan(idTabHD) {
        $.ajax({
            url: `/api/ban-hang/phuong-thuc-thanh-toan/${idTabHD}`,
            method: 'GET',
            success: function (result) {
                const listContainer = $("#listPhuongThucThanhToan");
                listContainer.empty();

                if (result.length === 0) {
                    tienDaThanhToan = 0;
                    $('#tienKhachDuoc').text(`${formatVND(0)}`);
                    listContainer.html(`
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">Chưa thanh toán</td>
                    </tr>
                `);
                } else {
                    tienDaThanhToan = 0;
                    let list = "";
                    for (let i = 0; i < result.length; i++) {
                        tienDaThanhToan += result[i].tienDaThanhToan;
                        list += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${i + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatVND(result[i].tienDaThanhToan)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${result[i].tenThanhToan}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                        <button class="deletePTTT" data-id="${result[i].id}">
                        <i class="fa-solid fa-delete-left"></i>
                        </button>
                        </td>
                    </tr>`;
                    }
                    $('#tienKhachDuoc').text(`${formatVND(tienDaThanhToan)}`);
                    listContainer.html(list);
                }
            },
            error: function (error) {
                console.error('Lỗi Lịch sử thanh toán:', error);
            }
        });
    }

    //update tt hd hai
    function updateTrangThaiHoaDon(trangThai, idHD) {
        $.ajax({
            url: `/api/ban-hang/update-trang-thai/${idHD}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({trangThai: trangThai}),
            success: function (response) {
            },
            error: function (xhr, status, error) {
                console.error('Lỗi khi cập nhật trạng thái hóa đơn: ', error);
                alert('Đã xảy ra lỗi khi cập nhật trạng thái hóa đơn. Vui lòng thử lại sau.');
            }
        });
    }

</script>

<script>
    $(document).ready(function () {


        let checkThanhToan = 0;

        function toggleThongTinShip() {
            $('#toggle-button').on('click', function () {
                $(this).toggleClass('active');

                if ($(this).hasClass('active')) {
                    $('#thongTinShip').addClass('show');  // Hiển thị phần thông tin ship
                    $('#thongTinShip2').removeClass('show');  // Ẩn thông tin ship cũ
                } else {
                    $('#thongTinShip').removeClass('show');  // Ẩn phần thông tin ship
                    $('#thongTinShip2').addClass('show');  // Hiển thị thông tin ship cũ
                }
            });
        }

        toggleThongTinShip();


        $('#btnTienMat').click(function () {
            var tienDaThanhToan = $('#inputSoTien').val();
            if (tienDaThanhToan && !isNaN(tienDaThanhToan)) {
                addPhuongThucThanhToanTienMat(idTabHD, tienDaThanhToan);
                getDuLieu(idTabHD);
            } else {
                alert("Vui lòng nhập số tiền hợp lệ.");
            }
        });

        $('#btnChuyenKhoan').click(function () {
            const maHD = $('#maHD').val();
            if (!maHD || maHD.trim() === '') {
                alert("Mã hóa đơn chưa được nhập hoặc không hợp lệ.");
                return;
            }
            const tienDaThanhToan = $('#inputSoTien').val();
            if (tienDaThanhToan && !isNaN(tienDaThanhToan)) {
                chuyenKhoan(tienDaThanhToan, maHD);

            } else {
                alert("Vui lòng nhập số tiền hợp lệ.");
            }

        });


        function chuyenKhoan(tienDaThanhToan, maHD) {
            $.ajax({
                url: `/api/payment/create_payment?tienDaThanhToan=${tienDaThanhToan}&maHD=${maHD}&chuyenTrang=0`,
                method: 'GET',
                success: function (response) {
                    if (response.status === 'Ok' && response.url) {
                        addPhuongThucThanhToanChuyenKhoan(idTabHD, tienDaThanhToan)
                        window.location.href = response.url;
                        getDuLieu(idTabHD);
                        PhieuGiamGiaPhuHop(tongTienTrongHD);
                        updateTrangThaiHoaDon(3, idTabHD);
                        sessionStorage.setItem('paymentSuccess', 'true');
                    } else {
                        alert(response.message || "Không thể tạo thanh toán. Vui lòng thử lại.");
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi khi tạo thanh toán:', error);
                    alert('Không thể thực hiện thanh toán. Vui lòng thử lại.');
                }
            });
        }

        if (sessionStorage.getItem('paymentSuccess') === 'true') {
            alert("Thanh toán thành công!");
            sessionStorage.removeItem('paymentSuccess');
        }

        $('#xacNhanThanhToan').click(function () {
            getDuLieu(idTabHD); // Lấy dữ liệu (bao gồm idPGG)
            hiddenModalThanhToan(); // Ẩn modal thanh toán
        });


        function hiddenModalThanhToan() {
            $('#modalThanhToan').val('');
            $('#modalThanhToan').hide();  // Ẩn modal
            $('.modal-backdrop').remove();  // Xóa lớp backdrop (nếu có)

            // Khôi phục lại overflow của body để trang có thể cuộn
            $('body').css('overflow', 'auto');
        }


        function showConfirm(callback) {
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: "Bạn không thể hoàn tác hành động này!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Vâng, tiếp tục!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    callback(); // Nếu người dùng xác nhận, gọi callback
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    Swal.fire(
                        'Đã hủy!',
                        'Hành động của bạn đã bị hủy.',
                        'error'
                    );
                }
            });
        }

// Xử lý thanh toán
//         $('#thanhToanTong').click(function () {
//             showConfirm(function () {
//                 // Kiểm tra nếu idTabHD null hoặc không hợp lệ
//                 if (!idTabHD) {
//                     showNotification("Vui lòng chọn hóa đơn trước khi thanh toán", "thatBai");
//                     return;
//                 }
//
//                 // Kiểm tra điều kiện thanh toán
//                 if (checkThanhToan === 0) {
//                     if (tongTienTrongHD - GiamToiDa === 0) {
//                         showNotification("Thanh toán thất bại", "thatBai");
//                     } else if (tienDaThanhToan < tongTienTrongHD - GiamToiDa) {
//                         showNotification("Thanh toán thất bại", "thatBai");
//                     } else {
//                         // updateTongTien(tongTienTrongHD, idTabHD);
//                         updateTrangThaiHoaDon(3, idTabHD); // Cập nhật trạng thái hóa đơn
//                         renderTabs(); // Cập nhật giao diện
//                         showNotification("Thanh toán thành công", "thanhCong");
//                         window.location.href = 'http://localhost:8080/admin/ban-hang-tai-quay'; // Chuyển hướng sau khi thanh toán thành công
//                     }
//                 }
//             });
//         });


        $('#thanhToanTong').click(function () {
            showConfirm1("Bạn có chắc chắn muốn thanh toán không?", function () {
                if (!idTabHD) {
                    showNotification("Vui lòng chọn hóa đơn trước khi thanh toán", "thatBai");
                    return;
                }

                if (checkThanhToan === 0) {
                    if (tongTienTrongHD - GiamToiDa === 0) {
                        showNotification("Thanh toán thất bại", "thatBai");
                    } else if (tienDaThanhToan < tongTienTrongHD - GiamToiDa) {
                        showNotification("Thanh toán thất bại", "thatBai");
                    } else {
                        updateTrangThaiHoaDon(3, idTabHD);
                        renderTabs();
                        showNotification("Thanh toán thành công", "thanhCong");

                        setTimeout(() => {
                            showConfirm1("Bạn có muốn xuất hóa đơn không?", function () {
                                exportInvoiceToPDF(idTabHD, function () {
                                    window.location.href = 'http://localhost:8080/admin/ban-hang-tai-quay';
                                });
                            }, function () {
                                Swal.fire(
                                    'Hoàn tất!',
                                    'Bạn đã chọn không xuất hóa đơn.',
                                    'success'

                                ).then(() => { console.log(idTabHD + "hoa don ${idTabHD}")
                                    window.location.href = 'http://localhost:8080/admin/ban-hang-tai-quay';
                                });
                            });
                        }, 500); // Thời gian chờ
                    }
                }
            });
        });


        function showConfirm1(message, onConfirm, onCancel) {
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: message,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Vâng, tiếp tục!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (typeof onConfirm === 'function') {
                        onConfirm(); // Gọi callback khi người dùng chọn "Có"
                    }
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    if (typeof onCancel === 'function') {
                        onCancel(); // Gọi callback khi người dùng chọn "Không"
                    }
                }
            });
        }

        function exportInvoiceToPDF(idTabHD, callback) {
            $.ajax({
                url: `/admin/invoice/export-pdf/${idTabHD}`, // URL endpoint xử lý xuất PDF
                method: 'GET',
                success: function () {
                    showNotification("Xuất hóa đơn thành công", "thanhCong");
                    if (typeof callback === 'function') {
                        callback(); // Gọi callback nếu việc xuất hóa đơn thành công
                    }
                },
                error: function () {
                    showNotification("Xuất hóa đơn thất bại", "thatBai");
                }
            });
        }


        $('#loadPGG').click(function () {
            getDuLieu(idTabHD);
            showNotification("Áp dụng phiếu giảm giá thành công", "thanhCong");
        });


    });
</script>


</html>
